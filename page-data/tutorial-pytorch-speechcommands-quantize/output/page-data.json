{"componentChunkName":"component---src-templates-blog-post-js","path":"/tutorial-pytorch-speechcommands-quantize/output/","result":{"data":{"markdownRemark":{"html":"<p>In this post, we want to see if the speech commands recognition model we trained in the <a href=\"https://jumpml.com/tutorial-pytorch-speechcommands/output/\">previous post</a> actually works on real recorded data.</p>\n<p>In addition we will learn how to quantize weights in PyTorch. This will help make the model smaller and potentially faster for prediction. Performance may or may not get worse.</p>\n<p>This notebook is available on github at this <a href=\"https://github.com/jumpml/pytorch-tutorials/blob/master/SpeechCommands_CNN_quantize.ipynb\">link</a>.</p>\n<h2>Model Loading</h2>\n<p>In a previous post, we trained a simple CNN model to recognize speech commands. We will load the same exact model with the same input size, kernel sizes, layers, etc. There are two steps in model loading</p>\n<ol>\n<li>Model instantiation: this is the skeleton with space for the parameters</li>\n<li>Parameter loading from a previously saved .pt file</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">PATH <span class=\"token operator\">=</span> <span class=\"token string\">\"./models/speech_commands_model.pt\"</span>\nnnModel <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>SpeechCommandsModel<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>       <span class=\"token comment\"># Instantiate our model and move model to GPU if available</span>\nnnModel<span class=\"token punctuation\">.</span>load_state_dict<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>PATH<span class=\"token punctuation\">,</span> map_location<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nnnModel<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SpeechCommandsModel(\n  (conv1): Conv2d(1, 32, kernel_size=(8, 20), stride=(1, 1))\n  (bn1): BatchNorm2d(32, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n  (conv2): Conv2d(32, 8, kernel_size=(4, 10), stride=(1, 1))\n  (bn2): BatchNorm2d(8, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n  (fc1): Linear(in_features=1536, out_features=128, bias=True)\n  (bn3): BatchNorm1d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)\n  (fc2): Linear(in_features=128, out_features=11, bias=True)\n)</code></pre></div>\n<h2>Model Quantization</h2>\n<p>As of PyTorch 1.6.0, there are three ways to quantize a model</p>\n<ol>\n<li>Dynamic Quantization: quantized weights applied post-training</li>\n<li>Static Quantization: fuses layers like BatchNorm and Relu, uses data for calibration applied post-training</li>\n<li>Quantization-aware training: static quantization during training</li>\n</ol>\n<p>We will try out the easiest one, dynamic quantization, which I am just going to call weight quantization. Basically we need to tell the quantizer which layers we want to quantize, for e.g. nn.Linear usually has a lot of parameters and is a prime candidate for weight quantization and what the target data type is. Since parameters are float32, the two options available are float16 or qint8. We will convert Conv2d and Linear layers to 8-bit parameters.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">quantized_model <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>quantization<span class=\"token punctuation\">.</span>quantize_dynamic<span class=\"token punctuation\">(</span>\n    nnModel<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>qint8<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">utils<span class=\"token punctuation\">.</span>print_size_of_model<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">)</span>\nutils<span class=\"token punctuation\">.</span>print_size_of_model<span class=\"token punctuation\">(</span>quantized_model<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Size (MB): 0.864021\nSize (MB): 0.271357</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">lossFn <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>nll_loss  <span class=\"token comment\">#When we combine nll_loss and log_softmax we get a cross entropy loss</span>\nevalSC <span class=\"token operator\">=</span> <span class=\"token builtin\">eval</span><span class=\"token punctuation\">.</span>evalModel<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span>\nevalSCq <span class=\"token operator\">=</span> <span class=\"token builtin\">eval</span><span class=\"token punctuation\">.</span>evalModel<span class=\"token punctuation\">(</span>quantized_model<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> device<span class=\"token punctuation\">)</span>\nevalSC<span class=\"token punctuation\">.</span>evalClass<span class=\"token punctuation\">(</span>sc_data<span class=\"token punctuation\">.</span>test_loader<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Avg. loss: 0.0007, Accuracy: 94.42631530761719 %  Elapsed Time=126.23865580558777</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">evalSCq<span class=\"token punctuation\">.</span>evalClass<span class=\"token punctuation\">(</span>sc_data<span class=\"token punctuation\">.</span>test_loader<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Avg. loss: 0.0007, Accuracy: 94.39006805419922 %  Elapsed Time=36.33142900466919</code></pre></div>\n<h2>To Quantize or Not to Quantize?</h2>\n<p>Here is the deal</p>\n<ol>\n<li>Size went down from 0.86 MB to 0.27 MB</li>\n<li>Accuracy is slightly worse, but pretty much the same: 94.42% to 94.39%</li>\n<li>Processing time of the test set evaluation went from 2 minutes to half a minute!</li>\n</ol>\n<p>Usually there are no free lunches, but what we have here is a free lunch, a proverbial no-brainer.</p>\n<h2>Recording real-world data</h2>\n<p>I used Audacity, a free audio editing tool, to record me saying twenty commands one after the other. After that, I wrote up an Energy-based Voice Activity Detector (VAD) which basically finds the words in the long recording:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aa75e30e0b52c3c0000a8ed42afb0e9f/5819f/VAD.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.45945945945947%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAxNAAAMTQHSzq1OAAAC+ElEQVR42o1U224jRRD1r/AdvGUTeOCXeGBBCGk/hweEkBAgRRChkN04WTt2Esf29NzHM+O59vTtUDVxlAVlES2V5lTVqVNVtronq9XqUynlrRqG2TAM85dMypfjH9hMKXXbtu1vk6qqjh0+fiwlpf4vxvPRWqcT4fsn1hg41Rmnegs9WCtrSz5hac3Q2a5rCffWkc9x5j3aE+4MrAZt6U3ysnpFRKCOHOrYoStQ+zfQhQC6HLpOKRTD1QlcVzIPbRHBtMWIx/jet1yn+tafZHl5bJWEKkNnq9jZNkeweo8m9SCrHYo0RJFFaPII6PckEmO/i6DbcsREBKrAoj8IRnFyoocem82DqzLfscj9zRRZuEYUhQhDH3EUwPO2yLIEZSKQJQFknSMNt2ipUZVsrW5oG0mCddsdGdVjtly6IhGuLTM8LC4RixXWnkAQCAhf4PLmFkEUIRBrrLcbpGmCJNggDDzmWkUNDAvui/ykrGp8//vU3T+s3XLt4fT8AteLJU6v7nB2fYeLmxV+/muOP96v8I6Efzqf4YfzBX69mOFycY8/r+a23CWPE1ZFdlx1Ej9e+e42Ktlwdp9i6u1wdpfgyssx3e7wyzzE23WGuV/gdBmPdi2KMfd2vbM1aWilaMKyeGWsxaVXuriSruwUVmmDza7FbVwjqSSCssdUlOP3yWdeWkuIomPfKuNgjPYnwtt+ro3FIqpc0Q6ukXoU5MLwIBDve4i8HUWIg7wZwDUcZ35aSTtoC6NJkG7KkXOOic5Y5zRN+0CCVa/AJC5mEanMeBuYyzkWNPbxBklyqJRuCq0shPiMScxl40RGqxADjFuaoBuexfjwVNz4g9joKP4N0zQ95qAbc4/Zjqaxh+48xb8FuZH7pz0LZll2dCAq+ioqU7SqsgdMkygSVE/5j9hwENxMfN//4qnzy6+NgzL2f702xpiGJ/yE/phvu657zRaG4Rt6175mHATBiNkYc6xpmhH3ff+6rutvmE/v6Vf7/f47z/O+/Bsbl/60KNQEcwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"VAD\"\n        title=\"VAD\"\n        src=\"/static/aa75e30e0b52c3c0000a8ed42afb0e9f/fcda8/VAD.png\"\n        srcset=\"/static/aa75e30e0b52c3c0000a8ed42afb0e9f/12f09/VAD.png 148w,\n/static/aa75e30e0b52c3c0000a8ed42afb0e9f/e4a3f/VAD.png 295w,\n/static/aa75e30e0b52c3c0000a8ed42afb0e9f/fcda8/VAD.png 590w,\n/static/aa75e30e0b52c3c0000a8ed42afb0e9f/efc66/VAD.png 885w,\n/static/aa75e30e0b52c3c0000a8ed42afb0e9f/5819f/VAD.png 1042w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>At the end, we have a set of twenty files corresponding to the twenty commands I read. The filename contains the true command label.</p>\n<p>The next steps are to setup a feature preprocessing pipeline so we can feed the features to the model. After some copy and paste of the dataset code, we create a function:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> scd<span class=\"token punctuation\">.</span>get_file_features<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> padLR<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>which takes a filename and returns the features X (101 frames of 64 log Mel features) and label y. This function also allows to pad silence to the right of the command or pad on both left and right of the command.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> <span class=\"token builtin\">file</span> <span class=\"token keyword\">in</span> testFiles<span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> scd<span class=\"token punctuation\">.</span>get_file_features<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> padLR<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span>evalSCq<span class=\"token punctuation\">.</span>predictClass<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> pred <span class=\"token operator\">==</span> y<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'\\033[1;30;47m Ground Truth = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>y<span class=\"token punctuation\">}</span></span><span class=\"token string\"> \\tPrediction = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pred<span class=\"token punctuation\">}</span></span><span class=\"token string\">   \\tConfidence=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conf <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">%'</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'\\033[1;30;41m Ground Truth = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>y<span class=\"token punctuation\">}</span></span><span class=\"token string\"> \\tPrediction = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pred<span class=\"token punctuation\">}</span></span><span class=\"token string\">   \\tConfidence=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conf <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">%'</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\u001b[1;30;47m Ground Truth = 4 \tPrediction = 4   \tConfidence=69.92%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=91.55%\n\u001b[1;30;47m Ground Truth = 8 \tPrediction = 8   \tConfidence=99.97%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=77.36%\n\u001b[1;30;47m Ground Truth = 3 \tPrediction = 3   \tConfidence=56.72%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=98.91%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=98.08%\n\u001b[1;30;47m Ground Truth = 1 \tPrediction = 1   \tConfidence=95.63%\n\u001b[1;30;47m Ground Truth = 7 \tPrediction = 7   \tConfidence=94.43%\n\u001b[1;30;47m Ground Truth = 9 \tPrediction = 9   \tConfidence=99.46%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=84.82%\n\u001b[1;30;47m Ground Truth = 0 \tPrediction = 0   \tConfidence=99.06%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=75.87%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=95.41%\n\u001b[1;30;47m Ground Truth = 5 \tPrediction = 5   \tConfidence=89.63%\n\u001b[1;30;47m Ground Truth = 6 \tPrediction = 6   \tConfidence=84.86%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=98.45%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=96.55%\n\u001b[1;30;41m Ground Truth = 2 \tPrediction = 10   \tConfidence=44.08%   ===> OH NOOOOOOOOOOOOOO\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=69.66%</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># VISUALIZE SOME EXAMPLES</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">visualize_file_prediction</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> evalSC<span class=\"token punctuation\">,</span> padLR<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> scd<span class=\"token punctuation\">.</span>get_file_features<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span>padLR<span class=\"token operator\">=</span>padLR<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span>evalSC<span class=\"token punctuation\">.</span>predictClass<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span>\n    fig<span class=\"token operator\">=</span>plt<span class=\"token punctuation\">.</span>figure<span class=\"token punctuation\">(</span>figsize<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dpi<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>tight_layout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> cmap<span class=\"token operator\">=</span><span class=\"token string\">'jet'</span><span class=\"token punctuation\">,</span> origin<span class=\"token operator\">=</span><span class=\"token string\">'lower'</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Ground Truth: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>scd<span class=\"token punctuation\">.</span>KNOWN_COMMANDS<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">    Prediction:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>scd<span class=\"token punctuation\">.</span>KNOWN_COMMANDS<span class=\"token punctuation\">[</span>pred<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n\nvisualize_file_prediction<span class=\"token punctuation\">(</span>testFiles<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> evalSCq<span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 542px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0ad18f71da0683421c5769d8394aef6/c0388/output_15_0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAxNAAAMTQHSzq1OAAAC/ElEQVR42oWUWUhUURjH/3PHsrEgChy3FqOUUkpb1AxaHjKiIVNbTOvBiIpIiJaxzBwzaKeNopceEitaMDPaNJMeWrCwmko0yqTIVLIm52rqzNw7/z6bipDIhx/fueee/59zzvd9B8b04qHArSBEXzQbcs4GYkJGJKZbYpG4MBbRyTGYtyISKZnjERY/DYiIASInA+OmyljinBHA8kAgzQykBgEWf2CB48agQ500rnepsLATi9mFFE8PZrq7YHF3Y6kmyFxUTQ+wuRsGm8Q8lyAx/7vQCdicwE4CW5Jh2thcObqmgUjqJvw+EEMa6JfQTiWHxMgOYsAbwv89oZSIIFcoFAr64hVjiVvToBxouzPqcwMD8hwe4KH8OOpVYu55B533eBH8Tr7PCEeEPb0ir09s+xtd5jy/DFNxuWpuRVvZMO7p2qyNq62nsqyZgxOfc3i5gwhvl0VlhEHAEfqO1Xd3vaZ/GZbUzqz8aA/mYc86LdLxkljSTSWwjoY4lTBVyKLTwnlhb6+4f8PspoKKIi5lVKddg6WdBtwgQp8Q8R5Z8Ey4IFwVDtIn6sfwXN3cyoamEK7pOK4FFH8jJrYQsV/of8lFxeYlBjcRxlbhlgi2C7v+b9hywlTODFB9FKDtopVBrz5RrooB151UCmSX4bpkWxjyQAQ5/Rs+tYZWvp0FNp4aqtk7opn19ST9inpoOioJydSIBBcRJyUUZu8V/KNs+hg2Zplu2wG25vp7qjlFn1VXrsc+eKynamf1gee6dCS6dCTpOiZVS3lYdRgKdV+p/OR32bj/GL44FnaXs0HuBovc6VSuuBlRXE9zqdzlNtKQLcfeLztMlETBKiX0z8L+lTBrGvY9y7p2p36GXlU73TH/Xok6cEej6rf4tdO4tslpyHerxk0tKjJanQitkPbKUUUsMf83qi/aHNKKYrgpGdiwOwS8GQyWmmG+PxJID5eelWY/KBSOAVbL3CoZLwqCMmMskBwKZMpDsCQYiI+Qx0HGK+V/0mhgROAPZSnbci86nS8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/f0ad18f71da0683421c5769d8394aef6/c0388/output_15_0.png\"\n        srcset=\"/static/f0ad18f71da0683421c5769d8394aef6/12f09/output_15_0.png 148w,\n/static/f0ad18f71da0683421c5769d8394aef6/e4a3f/output_15_0.png 295w,\n/static/f0ad18f71da0683421c5769d8394aef6/c0388/output_15_0.png 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>What if the speech was more centered? Would the prediction change? Let see.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">visualize_file_prediction<span class=\"token punctuation\">(</span>testFiles<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> evalSCq<span class=\"token punctuation\">,</span> padLR<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 542px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f21554f26726b732088ff368cbb2a865/c0388/output_17_0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAxNAAAMTQHSzq1OAAADSElEQVR42o2Ua0hUaRjH/+eMmgkVSzY6jpHVphFKFxfbopXKzKJN03EztVqhhIJgd8vVRJ2ZzFzc6LJBtFZUH7ILSGzitpUtLOwNNqioYLuY1lBagzWdYRrHnHP++xz1g237YRn+vOd9531+57keAAUTRHFQCq3Ap3FqqjMWsdXTgNx0LFydhuk5czC/OEUpKP8QKdkZmLdyDpatSUVpvQ1qidjkixzmGgesGgOgsh1wEorLD1QEMK0tELUrHIys9Q1gJYPIZz8+C4ewOBzEslBInvvhoOxfv4G6JwDUiJwaUEtgR64AqzsAlwB3yUElkdLOpOsextS/JtQ+YsIDqgleRlQMEot0wtJNRHfK+pvcN23EGbgNoE7WigIBVl0dAqruQQEaWNBuxPe8MOIueQxM6paLRw2oLUb0cc1QV/lk/4Nov+hbkVPk0kWDI8B8Ae68YgJVizNsvvGTsu30diTwclcmM7y/ctzeXir2e7Se76K6TrzELxJNq6wnORymy/gXsKpjNHB+UTWfP7SzrSeLWbzIqO/6iQ+6qc71ErbbYnRcdFp0iMOQ94DDHioWV9h8o33pYZ7hWvmdIPa9lUuSK8tVYqFf8vlM9q0jOvZ/PHQzvaiWnr5ENvuKafvrMdW8l0TCc0Y2BBnZIkVJ1sRQChN51ywGR/I4Glh92QRa1DoBNrLIUUxuA/WD4AWuYPrAH0QTGX00wKizQeIjEvYwMdEjgAYz7P/2cBi4hwXZZXzhAP/eMoadD5N4gOWc2NbLsc1+qltCxHLxMm1A9EoA35hhC9D9joc/DQGVOjls1D9fWqh7kqB3zob+qG+K/oWvUbddeqJvCHyv22906cijjiUhHYt7pV12m/1nts3b0UW5ZuZCPBwKIcexldwIshC88ySZM+/fZszeAGf9LBV2k8o2KVS9hL1Jcovd0kLOkVya9l+bjV15URKrK5a6V3Lon5nX6P/xaY72+81Ureq6yz/+yCO/paRbi9jwQFN2vPFHOH0ayno0zLsl49Yg41ojq1NsawT4lTl6H9uA0ngo660qMicjtjwJ3j+tMTxlRf65qUDTZKBchr9Ghv/L6bJPADabH4J4IGMGsE6eS+X/7ClA4qR/AA6o2Jf2sTsvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/f21554f26726b732088ff368cbb2a865/c0388/output_17_0.png\"\n        srcset=\"/static/f21554f26726b732088ff368cbb2a865/12f09/output_17_0.png 148w,\n/static/f21554f26726b732088ff368cbb2a865/e4a3f/output_17_0.png 295w,\n/static/f21554f26726b732088ff368cbb2a865/c0388/output_17_0.png 542w\"\n        sizes=\"(max-width: 542px) 100vw, 542px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> <span class=\"token builtin\">file</span> <span class=\"token keyword\">in</span> testFiles<span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> scd<span class=\"token punctuation\">.</span>get_file_features<span class=\"token punctuation\">(</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">,</span> padLR<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">(</span>pred<span class=\"token punctuation\">,</span> conf<span class=\"token punctuation\">)</span><span class=\"token operator\">=</span>evalSCq<span class=\"token punctuation\">.</span>predictClass<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> pred <span class=\"token operator\">==</span> y<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'\\033[1;30;47m Ground Truth = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>y<span class=\"token punctuation\">}</span></span><span class=\"token string\"> \\tPrediction = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pred<span class=\"token punctuation\">}</span></span><span class=\"token string\">   \\tConfidence=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conf <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">%'</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'\\033[1;30;41m Ground Truth = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>y<span class=\"token punctuation\">}</span></span><span class=\"token string\"> \\tPrediction = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>pred<span class=\"token punctuation\">}</span></span><span class=\"token string\">   \\tConfidence=</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conf <span class=\"token operator\">*</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2f</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">%'</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\u001b[1;30;47m Ground Truth = 4 \tPrediction = 4   \tConfidence=99.95%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.91%\n\u001b[1;30;47m Ground Truth = 8 \tPrediction = 8   \tConfidence=100.00%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=83.48%\n\u001b[1;30;47m Ground Truth = 3 \tPrediction = 3   \tConfidence=99.73%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.49%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.83%\n\u001b[1;30;47m Ground Truth = 1 \tPrediction = 1   \tConfidence=98.30%\n\u001b[1;30;47m Ground Truth = 7 \tPrediction = 7   \tConfidence=99.97%\n\u001b[1;30;47m Ground Truth = 9 \tPrediction = 9   \tConfidence=100.00%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.73%\n\u001b[1;30;47m Ground Truth = 0 \tPrediction = 0   \tConfidence=100.00%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.26%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.59%\n\u001b[1;30;47m Ground Truth = 5 \tPrediction = 5   \tConfidence=99.99%\n\u001b[1;30;47m Ground Truth = 6 \tPrediction = 6   \tConfidence=99.69%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=97.21%\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=99.59%\n\u001b[1;30;47m Ground Truth = 2 \tPrediction = 2   \tConfidence=98.81%   ==> ALRIGHTY THEN\n\u001b[1;30;47m Ground Truth = 10 \tPrediction = 10   \tConfidence=56.80%</code></pre></div>\n<h2>Conclusion</h2>\n<p>Quantizing to 8-bit parameters is a great thing to do for our pre-trained speech commands model.</p>\n<p>We also noticed the fragility of the model to where in the spectrogram the word is. This may not be an issue in practice, as the model may be run multiple times a second on overlapping data. Yet, it shows that there is more work to do on getting a more invariant representation. We see the need for more tools to perform sensitivity analysis to noise and perturbations like time shift. And the need to understand why the model is getting confused by using model interpretability libraries like <a href=\"https://captum.ai\">Captum</a>. These will be topics for a future post.</p>","excerpt":"In this post, we want to see if the speech commands recognition model we trained in the previous post actually works on real recorded data. In addition we willâ€¦","frontmatter":{"title":"Predictions on real data and model quantization (Tutorial)","date":"2020-08-28T00:00:00.000Z","subject":["ml","tutorial","pytorch","audio","speech","kws","voice","cnn","quantization"],"author":"RSP","featimg":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAxNAAAMTQHSzq1OAAAC6UlEQVR42m2TaUhUURTH/+89RdwyFygI+pDhSH5IKgTFStKkIp3JBXPSpNxaFBozl8ZxNFMyIYK00LQsDIxAsFzIPrRRqUhhWC4RZRQRYmm04Djvns4bTcL88OO+97jnx/+8ey6AICcgNwrIi4N0XA8cNiCiT4/I3gOI7MiEoSMDu7vSkdJvRFR3BvTt2dh/JxMZg3vhdyEWOGIAtDpTAtf6AwjwAYo/AFaCVEZAISk7hsm35RvJqbOEMCJsZyKZCGbL/Kp9d7/C+4sYra6UOVHAwg2ewMnXDqFcZuMNdilnxL5i4osdm37bgSdMj90p4bNdqRb8PMp0MbeZKsbCWGfmhcdYGOTFCUfmhFYVMAtdZbtI/9Qkgm4NCOfw5wIuLcI1rl+4188IyMMCaBCQ6ngtZ0oZq31eaPqbcFgTKrKFhVV0qZ576gTVk5ECaZgQL8hj5xi5lk0TnPu48CbTypTTEsL1y1joSCgrpSysoH21ZuqmaEqcuk6eZ8cJKwcJy1nsPcFFLUwzU8tYGOtiYaA3tzw6J7Q4hMkNFrpHEeQ//YoQbeONDwkhLM7hg1g9PvcuaUnPMCWLheHui1uur95KVAfqHNtGERM95FRlI+XgDHmNTBLyWer2kxN/ZWkDS4pZWPZfQkfLijQnvHo0lCgRNNXjQjfIQMGjvYQaFpXbeWSYIE6t49VFa71osTB0IaEMh1Bc2xMsBjwh3pR4iSGbTux82ybWPX0hQkYfCJhJYOMPgc184l7NYglhgJbQMYcKLLMsVJuyw1RaA9VWI6kXKU2VW21q2ONHqu7ZkIosUmFUVZh49W3kAMWMNr8Lc6h35YTvHAll7dROk+lcFn3sXEVDd9dSystGUiomySP/PUkF30mqnCX5FI9PMuNxWfuH/9yUgnwW+rgB6bv4PhokJY/v5qGkQOv5+FwqjE39ZTYgbSAZfl16eHbFQnc/AYH9SfDtiYVzG9/fXCOQEwfkx/BzEhAT/Ae2t7hJYvD25wAAAABJRU5ErkJggg==","aspectRatio":1.492537313432836,"src":"/static/f21554f26726b732088ff368cbb2a865/497c6/output_17_0.png","srcSet":"/static/f21554f26726b732088ff368cbb2a865/65e33/output_17_0.png 100w,\n/static/f21554f26726b732088ff368cbb2a865/69585/output_17_0.png 200w,\n/static/f21554f26726b732088ff368cbb2a865/497c6/output_17_0.png 400w,\n/static/f21554f26726b732088ff368cbb2a865/00f6e/output_17_0.png 542w","sizes":"(max-width: 400px) 100vw, 400px"}}}},"fields":{"slug":"/tutorial-pytorch-speechcommands-quantize/output/","readingTime":{"text":"7 min read"}}},"site":{"siteMetadata":{"title":"JumpML"}}},"pageContext":{"slug":"/tutorial-pytorch-speechcommands-quantize/output/"}},"staticQueryHashes":["2046284594","429448491"]}