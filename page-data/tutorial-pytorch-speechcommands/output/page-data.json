{"componentChunkName":"component---src-templates-blog-post-js","path":"/tutorial-pytorch-speechcommands/output/","result":{"data":{"markdownRemark":{"html":"<p>This is a tutorial post on speech commands recognition using the <a href=\"https://arxiv.org/abs/1804.03209\">Speech Commands dataset</a>. The goals for this post</p>\n<ol>\n<li>Work with audio data using torchaudio: look at spectrograms features and data augmentation</li>\n<li>Train a model to recogize audio data from a vocabulary of spoken commands</li>\n<li>Evaluate model performance using measures like accuracy (error rate) and confusion matrix</li>\n</ol>\n<p>There are around 10 speech commands like Yes, No, Up, Down and so on. The dataset contains wav files sampled at 16000 Hz and each command waveform contains upto a second of data. In addition to the commands themselves, there are some words that are not commands (and phonetically diverse) and background files containing background noise and silence segments.</p>\n<p>We will rely heavily on the torchaudio package for input preprocessing. It has some convenient dataloaders and feature preprocessing transforms. The nice thing about torchaudio, is that the feature processing can take place on the GPU and this will accelerate the training process significantly.</p>\n<p>To install torchaudio, the command below should be executed in a terminal:<br>\nconda install -c pytorch torchaudio</p>\n<p>The -c option searches on the pytorch channel.</p>\n<p>This notebook is available on github at this <a href=\"https://github.com/jumpml/pytorch-tutorials/blob/master/SpeechCommands_CNN.ipynb\">link</a></p>\n<h2>Data Setup</h2>\n<p>We have created a wrapper around torchaudio’s SPEECHCOMMANDS dataset class. The wrapper performs the following steps for us</p>\n<ol>\n<li>Create train, val and test splits of the dataset</li>\n<li>Process the background noise files and creates 1 sec segments for augmenting each split</li>\n<li>Pad the data to 1s and map the string labels to integer. Number 11 corresponds to background or unknown.</li>\n<li>Creates dataloaders for each split with appropriate transforms (MelSpectrogram, etc.)</li>\n</ol>\n<p>The torchaudio class automatically downloads the data if not already on disk. If we look at the source code for the speechcommands dataset class in torchaudio, we need to specify the version of speech commands (v0.2). The dataset is around 2.3GB in size. Each item in the dataloader consists of the following information:<br>\nwaveform, sample<em>rate, label, speaker</em>id, utterance_number.</p>\n<p>In this tutorial, we are not using speaker<em>id or utterance</em>number. We are not downsampling the audio to 8kHz, which may be a good thing to do, since it is an effective way to throw away information that is not related to the task of recognizing commands. Most of the voice information is between 20 Hz to 3.6 kHz.</p>\n<h3>Feature Pre-Processing</h3>\n<p>Torchaudio comes with several useful <a href=\"https://pytorch.org/audio/transforms.html\">transforms</a>, which we can use to get our input features efficiently computed on GPU.</p>\n<p>Here is the feature processing we use for training data</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">self<span class=\"token punctuation\">.</span>train_transform <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>\n   torchaudio<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>MelSpectrogram<span class=\"token punctuation\">(</span>sample_rate<span class=\"token operator\">=</span><span class=\"token number\">16000</span><span class=\"token punctuation\">,</span> n_fft<span class=\"token operator\">=</span><span class=\"token number\">320</span><span class=\"token punctuation\">,</span> hop_length<span class=\"token operator\">=</span><span class=\"token number\">160</span><span class=\"token punctuation\">,</span> n_mels<span class=\"token operator\">=</span>n_mels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   torchaudio<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>FrequencyMasking<span class=\"token punctuation\">(</span>freq_mask_param<span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>n_mels<span class=\"token operator\">*</span><span class=\"token number\">0.2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   torchaudio<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>TimeMasking<span class=\"token punctuation\">(</span>time_mask_param<span class=\"token operator\">=</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.2</span> <span class=\"token operator\">*</span> <span class=\"token number\">16000</span><span class=\"token operator\">/</span><span class=\"token number\">160</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   torchaudio<span class=\"token punctuation\">.</span>transforms<span class=\"token punctuation\">.</span>AmplitudeToDB<span class=\"token punctuation\">(</span>stype<span class=\"token operator\">=</span><span class=\"token string\">'power'</span><span class=\"token punctuation\">,</span> top_db<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>A spectrogram is used to map the a waveform to a time-frequency representation which is almost always used in any kind of speech processing. We use a hop length of 10ms and a FFT size of 20 ms. In order to keep our inputs small, we also employ mel filterbanks to get 64 features in total. Then we convert the spectrogram magnitude to log-power scale in dB with a minimum floor of -80 dB. In order to get more general features, we additionally apply Frequency and Time masking on the training set only.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">batch_size_train <span class=\"token operator\">=</span> <span class=\"token number\">64</span>\n<span class=\"token comment\"># Setup train, val and test dataloaders</span>\nsc_data <span class=\"token operator\">=</span> scd<span class=\"token punctuation\">.</span>SpeechCommandsData<span class=\"token punctuation\">(</span>train_bs<span class=\"token operator\">=</span>batch_size_train<span class=\"token punctuation\">,</span> test_bs<span class=\"token operator\">=</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> val_bs<span class=\"token operator\">=</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> n_mels<span class=\"token operator\">=</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/842d14906ffb1a2c699e465c17560cca/d74fe/output_5_0.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 94.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAxNAAAMTQHSzq1OAAAFV0lEQVQ4yyVUaVAUZxB9M7sgsAtqMEUshWA0xrIUjUFFkyAiRjFWGY2UR0SMZ+TwwgPkFGRXFETQIJ5EoUATNUZDLSgmCBq88AgQ8NZlBQQTBGGV3Znp9OqP/jHv637f1/36DSDUhEFVnw7c0WGYMR1fPP0RU57sdgxp3mY3oUEP3MiAQ8VHgIM9EBMPIXYHsEGHr8/sFPvq935zITHdy3RHj4HlNjwGsHtUB3UXAU2k8ifS6hRySbRSn+hO0gabGZdJcKyZDEALJCgQ0hhLIsdVVSR8/DPlXZtBWZRMveZVMZ7wBrD/5xLUdfzx9xv7Na8sI9qvWr1ryy29dQ0WbXgTJzwlQXttAiBquKAZQiLnxnQ7jDligUu2dW1JhGXpg9xu9CwlARuNgFdDJQa2E/r/Ky2qzlFSKVzpW/5QUa1vV+zWtFkBI0FzzY9bZsL4VmALE8ZKQLoCbFMCcvcry7sOyj0+L7PhjRACzVcxlKhPUL3yuMqdWo/2ouBrB2nor7fIPf8ht9hMKhRPhMsnTJj0H6CztUZwPEUql0wqG+xGlA0KLs5mvLAZ4szOi5hMNGrp1U7SwUwl6KLrMC9q22d2Kzd2ItBMquFVvni/UAOPcyYgk19d0AWtwQy73K5Sn6FmmoeuopJpkuhf9xhCwMkQDCqKd/U5tCl04YT4uZFTdfPCpm51nVISjVFNUarp9YlY+dSD1bNDj4w1QFQssDkKQtIWJ99UXeCBzC2he36ICly8MVbdL3MVi7evEijm557im3+RgXyezXEZDndltXunBXhN8OjwEwBuOa6FiXj40Va4HJen52Uo85uPyohvlOB8hjlSnvHFZ6/A4QZBvCSLKCRRXUKi6iwfviT0Jlm9msj5WCuLwoRCwgsIySQiSoHzCVqSs5EKKIjcDt9TMNy2NoVNnFd0BShhJa9KcKvm11W8De8Fp5VNx/RSCOWTu6WaCQUNxMQXNpVV4mbu5KASm/atYlLclTl0SHaveEbO3xsb+d7av6C5T3B/bkG/55Ig1kgY0CAZivwkWoXu87cn0QzK5z0crxFUKc+BZFY9iUeRJ4WFRkiSDtL9y/0tBvKn3bSERVtgrhYiiDCHw/td2C8gqpzrTWYPEEXYk2UHAoB2rSgkdAsqm1OSSbP8AukMW6lhpRtVGXxo75u1tOJm6itg/ZNQYXHLDoS2pWD83Z0YcWuX0+jLmUdCv0z9M27k1t/jxu0sCxnEXs6xF4V1cezXVCBML2iyMj5INGQOPl26670VVXqM/yMVnobNcBx7Ig+IrgPW3WT2aiCyFljNsfsOkFbF7rjPDvB2AzliWGeZMOt1jbim45Z276MaBL2qxYBizg2/xRw1IjaUwnPdZS48ziqnEIRUm/SkctpPnovLyPW7SlL1yCcHMWISRNJidrdZ3M5jiSEaUnuPfFtuU6+Q37gmjgS77Vyf0A7/3YZKOF/m3dJbVeokVm+LPCsqTu5u6S0XtIVYMPKR7Wfgx9PU9K150OJjLie3l4+te8wh8gXyk8dExXNNvFVU234a8c8wreAUE14hNWIkDvZujrJn/lfK88M9lY49jtbtByLJKzbfbzid1IztKm2NlPW068FKqf66p3LQskxxCD/Ja7ZRgjrpHeHC3Ozr8O1gs59kIJ8CgrKodZoT0Qa8Nf1d42jykssmDlmbpvGmirafGoKJJvDZCJChMpBcYwq5LpoEdYqNsAWHzs88G3o648WyjDTjtPQjpsrDn5ooCqYXuVpTV5bwtProhy+zTs0eB8/XTtA1Vk9KPdZ8Mfsz4/WkwaYj5+abNLMKefc2GCHG8Y7G3PwfTbHKhRz2kf0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/842d14906ffb1a2c699e465c17560cca/fcda8/output_5_0.png\"\n        srcset=\"/static/842d14906ffb1a2c699e465c17560cca/12f09/output_5_0.png 148w,\n/static/842d14906ffb1a2c699e465c17560cca/e4a3f/output_5_0.png 295w,\n/static/842d14906ffb1a2c699e465c17560cca/fcda8/output_5_0.png 590w,\n/static/842d14906ffb1a2c699e465c17560cca/efc66/output_5_0.png 885w,\n/static/842d14906ffb1a2c699e465c17560cca/d74fe/output_5_0.png 1164w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Model Specification</h2>\n<p>The model we use is not too complicated:<br>\nInput X (B,1,64,101)<br>\n—> 32 Conv2D(8,20) —> BatchNorm2D —> MaxPool2D(2) —> ReLU<br>\n—> 8 Conv2D(4,10) —> BatchNorm2D —> MaxPool2D(2) —> ReLU<br>\n—> Linear(128) —> BatchNorm1D —> ReLU<br>\n—> Linear(11) —> LogSoftmax</p>\n<p>where B is Batch Size, the arguments to Conv2D are input numChannels, output numChannels and kernel size.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">model</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>conv1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>in_channels<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> out_channels<span class=\"token operator\">=</span>num_filters_conv1<span class=\"token punctuation\">,</span> kernel_size<span class=\"token operator\">=</span>C1_kernel_size<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn1   <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>num_filters_conv1<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>conv2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">(</span>num_filters_conv1<span class=\"token punctuation\">,</span> num_filters_conv2<span class=\"token punctuation\">,</span> C2_kernel_size<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn2   <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm2d<span class=\"token punctuation\">(</span>num_filters_conv2<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc1 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>fc1_in_size<span class=\"token punctuation\">,</span> fc1_out_size<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bn3   <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BatchNorm1d<span class=\"token punctuation\">(</span>fc1_out_size<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>fc2 <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>fc1_out_size<span class=\"token punctuation\">,</span> fc2_out_size<span class=\"token punctuation\">)</span>           <span class=\"token comment\"># number of classes = 11</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>max_pool2d<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn1<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mp2d_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>max_pool2d<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn2<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>conv2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> mp2d_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        x <span class=\"token operator\">=</span> x<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> fc1_in_size<span class=\"token punctuation\">)</span>    <span class=\"token comment\"># reshape</span>\n        x <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>relu<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>bn3<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>fc1<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">#x = F.dropout(x, training=self.training)  # Apply dropout only during training</span>\n        x <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fc2<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> F<span class=\"token punctuation\">.</span>log_softmax<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\nnnModel <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>       <span class=\"token comment\"># Instantiate our model and move model to GPU if available</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">model_parameters <span class=\"token operator\">=</span> <span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">lambda</span> p<span class=\"token punctuation\">:</span> p<span class=\"token punctuation\">.</span>requires_grad<span class=\"token punctuation\">,</span> nnModel<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nparams <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>np<span class=\"token punctuation\">.</span>prod<span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> p <span class=\"token keyword\">in</span> model_parameters<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Model size: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>params<span class=\"token punctuation\">}</span></span><span class=\"token string\"> parameters'</span></span> <span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Model size: 213891 parameters</code></pre></div>\n<h2>Objective or Loss Function</h2>\n<p>In the model the final layer is a log-softmax function, in other words, we get a vector of per-utterance log probabilities or log-likelihoods. So the output of the model is basically\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy=\"false\">(</mo><mi>y</mi><mi mathvariant=\"normal\">∣</mi><mi>x</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">\\hat{y} = \\log P(y | x)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">P</span><span class=\"mopen\">(</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord\">∣</span><span class=\"mord mathdefault\">x</span><span class=\"mclose\">)</span></span></span></span></p>\n<p>If we combine this with the nll_loss, which stands for negative log-likelihood loss which basically does the following operation</p>\n<span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>l</mi><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mo>−</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo stretchy=\"false\">[</mo><mi>y</mi><mo stretchy=\"false\">]</mo></mrow><annotation encoding=\"application/x-tex\">l(\\hat{y},y) = -\\hat{y}[y]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">−</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">]</span></span></span></span></span>\n<p>where <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span></span> is the true class label in <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>0</mn><mo separator=\"true\">,</mo><mn>1</mn><mo separator=\"true\">,</mo><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mi mathvariant=\"normal\">.</mi><mo separator=\"true\">,</mo><mi>C</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">{0,1,...,C-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8777699999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord\"><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">1</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mord\">.</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.07153em;\">C</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mord\">1</span></span></span></span></span>. If the model predicted the correct command with probability 1.0, then this loss would be 0.0. Otherwise it would be a positive number. By combining log-softmax and NLL loss, we get the Cross Entropy Loss.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Define objective function</span>\nlossFn <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>nll_loss  <span class=\"token comment\">#When we combine nll_loss and log_softmax we get a cross entropy loss</span></code></pre></div>\n<h2>Model Optimization or Training</h2>\n<p>The new parameters are the previous parameters with a step (proportional to learning rate <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>μ</mi></mrow><annotation encoding=\"application/x-tex\">\\mu</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\">μ</span></span></span></span>) in the direction (negative gradient of loss function w.r.t parameters) that reduces the loss function. In terms of math for a single labeled example <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>y</mi></mrow><annotation encoding=\"application/x-tex\">y</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span></span> and model prediction <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\hat{y}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span></span></span></span><br>\n<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>W</mi><mi>n</mi></msub><mo>=</mo><msub><mi>W</mi><mrow><mi>n</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>−</mo><mi>μ</mi><msub><mi mathvariant=\"normal\">∇</mi><mi>W</mi></msub><mi>l</mi><mo stretchy=\"false\">(</mo><mover accent=\"true\"><mi>y</mi><mo>^</mo></mover><mo separator=\"true\">,</mo><mi>y</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">W_n = W_{n-1} - \\mu \\nabla_{W} l(\\hat{y},y)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathdefault mtight\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.891661em;vertical-align:-0.208331em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.301108em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\">n</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.208331em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\">μ</span><span class=\"mord\"><span class=\"mord\">∇</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathdefault mtight\" style=\"margin-right:0.13889em;\">W</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathdefault\" style=\"margin-right:0.01968em;\">l</span><span class=\"mopen\">(</span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.69444em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span></span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.19444em;\"><span class=\"mord\">^</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.19444em;\"><span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.03588em;\">y</span><span class=\"mclose\">)</span></span></span></span></p>\n<p>For a batch of examples, we simply replace the loss above with some reduction such as the mean loss over the batch.</p>\n<p>We will also apply <strong>learning rate decay</strong> on the initial learning rate. The StepLR function will apply a decay of <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>γ</mi></mrow><annotation encoding=\"application/x-tex\">\\gamma</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.19444em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.05556em;\">γ</span></span></span></span> every step_size number of epochs to the exisiting learning rate in the optimizer.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">learning_rate <span class=\"token operator\">=</span> <span class=\"token number\">0.1</span>   <span class=\"token comment\"># Learning rate for optimizer like SGD usually in [0.001, 0.1]</span>\n<span class=\"token comment\"># Define optimization</span>\noptimizer <span class=\"token operator\">=</span> optim<span class=\"token punctuation\">.</span>SGD<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> lr<span class=\"token operator\">=</span>learning_rate<span class=\"token punctuation\">,</span> momentum<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Apply decaying Learning Rate</span>\nscheduler <span class=\"token operator\">=</span> optim<span class=\"token punctuation\">.</span>lr_scheduler<span class=\"token punctuation\">.</span>StepLR<span class=\"token punctuation\">(</span>optimizer<span class=\"token punctuation\">,</span> step_size<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> gamma<span class=\"token operator\">=</span><span class=\"token number\">0.25</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>Mechanics of Training</h2>\n<p>Basically has the following steps which we repeat until all batches of training data are consumed</p>\n<ol>\n<li>Get a batch of inputs (X) and corresponding labels (y), move to device</li>\n<li>Initialize gradients</li>\n<li>Calculate loss function on current batch of inputs and labels</li>\n<li>Calculate gradients by calling backward() on the loss function output</li>\n<li>Update parameters by calling optimizer.step()</li>\n</ol>\n<p>At the start of end of each epoch (when one complete round of training data has been used), the learning rate is decayed.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">train_losses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nTrainLen <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>sc_data<span class=\"token punctuation\">.</span>train_loader<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">train</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> optimizer<span class=\"token punctuation\">,</span> train_loader<span class=\"token punctuation\">,</span> log_frequency<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  model<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> batch_idx<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>X_train<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>train_loader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Move to device</span>\n    X_train<span class=\"token punctuation\">,</span> y_train <span class=\"token operator\">=</span> X_train<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">(</span>device<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Initialize gradients</span>\n    optimizer<span class=\"token punctuation\">.</span>zero_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Predict on current batch of data</span>\n    y_hat <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>X_train<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Calculate Average Loss</span>\n    loss <span class=\"token operator\">=</span> lossFn<span class=\"token punctuation\">(</span>y_hat<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Calculate Gradients</span>\n    loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># Update model parameters using SGD</span>\n    optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> batch_idx <span class=\"token operator\">%</span> log_frequency <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n      <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Train  </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>batch_idx <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>X_train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>TrainLen<span class=\"token punctuation\">}</span></span><span class=\"token string\"> Loss:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\\n'</span></span><span class=\"token punctuation\">)</span>\n      train_losses<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>loss<span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  scheduler<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># update learning rate for next call to train()</span></code></pre></div>\n<h2>Let’s Train</h2>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">val_losses <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nn_epochs <span class=\"token operator\">=</span> <span class=\"token number\">50</span>\nval_accuracy <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>n_epochs<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nlog_frequency<span class=\"token operator\">=</span><span class=\"token number\">100</span>\nval_accuracy<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>_ <span class=\"token operator\">=</span> evalModel<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> sc_data<span class=\"token punctuation\">.</span>val_loader<span class=\"token punctuation\">,</span> val_losses<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> n_epochs <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Epoch-</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>epoch<span class=\"token punctuation\">}</span></span><span class=\"token string\"> lr: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>optimizer<span class=\"token punctuation\">.</span>param_groups<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"lr\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span>\n  train<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> optimizer<span class=\"token punctuation\">,</span> sc_data<span class=\"token punctuation\">.</span>train_loader<span class=\"token punctuation\">,</span>log_frequency<span class=\"token punctuation\">)</span>\n  val_accuracy<span class=\"token punctuation\">[</span>epoch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>_ <span class=\"token operator\">=</span> evalModel<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> sc_data<span class=\"token punctuation\">.</span>val_loader<span class=\"token punctuation\">,</span> val_losses<span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Val set: Avg. loss: 0.0007, Accuracy: 94.9005126953125 %</code></pre></div>\n<h2>Performance Evaluation</h2>\n<p>The train dataset was used to train the model. The validation dataset is used to see if our model is overfitting or not over epochs. The test set is only gets used once at the end of model training and any architecture or hyperparameter optimization.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 508px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/14fa3709be47c4f18d2d6e8f90af1afb/2fd48/output_22_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.05405405405406%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAk6AAAJOgHwZJJKAAAB9ElEQVQ4y51TTW/TQBANCHHhAuJ3IX4EEif4DWkpVSFQVcCl6oEDgguXCiltk/IhgURQBO2hUiWK1ChJE9vrfJjaXjv2rvex67VTVwKRdK2nGe88v5nRk0sleQgZ3HVd/2cQBA1Kg6aM/0XKC2nTGdPmScdotlrH34fD4RelVzIM5xEufAQcZwTbthWSVLDdJstZMRJCcIlkFkithOtHfSMopV4qOBj4C1m7WBVmnu2MmiZxHNNUsNUy8pXZrII5TcX8myiKtOBoFJaLE84+41T8nOAVQtwHxQmzrvPgnOBly3IXs15M1S9kdXFlQsJyNNErK/uka5gHLGHalEibcskm4+XfPmBTwiyPCMuzYLomTE/ByqBza/p+dtd3DUFZABYzPSEwWdg7BLqmHwOJKC6SGzQ1St0lhfi3lUVir/w4AMplMGecUjEnhG6aCXquNmWlIia3boPfuw++uAT+dBV8fQN86SH46hr44wr4E3n36rW+W3umebLGnr+A6PUiV//LtlnJZz/cB/YawMdt4N1b4OsnYP8b8L6q88+7ura9Cbx5KfMtWZf8DzXAtDhSwaNfR3ecfq9BO90qTk92cNqpw23XEcg8NKrwVOxvpXloVUE7NdBuDWF3J+UMjnchhvUw8jdLM5wbGW5KXM/itX9wr/4Bko42iUzil9IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/14fa3709be47c4f18d2d6e8f90af1afb/2fd48/output_22_1.png\"\n        srcset=\"/static/14fa3709be47c4f18d2d6e8f90af1afb/12f09/output_22_1.png 148w,\n/static/14fa3709be47c4f18d2d6e8f90af1afb/e4a3f/output_22_1.png 295w,\n/static/14fa3709be47c4f18d2d6e8f90af1afb/2fd48/output_22_1.png 508w\"\n        sizes=\"(max-width: 508px) 100vw, 508px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As usual we will evaluate performance using accuracy rate, i.e. how many commands do we get correct on average. Another useful metric to look at is the confusion matrix, which tells us about how the model makes errors, when it makes errors.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">test_loss <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\naccuracy<span class=\"token punctuation\">,</span> cm <span class=\"token operator\">=</span> evalModel<span class=\"token punctuation\">(</span>nnModel<span class=\"token punctuation\">,</span> lossFn<span class=\"token punctuation\">,</span> sc_data<span class=\"token punctuation\">.</span>test_loader<span class=\"token punctuation\">,</span> test_loss<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'Test set accuracy = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>accuracy<span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Test set: Avg. loss: 0.0007, Accuracy: 94.42277526855469 %</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fdd383bd5ac698167850e7bd06abd7c3/f7616/output_26_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 84.45945945945947%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAxNAAAMTQHSzq1OAAADGElEQVQ4y31U3UsUURQfS1vdkiCkgnoJCg1UyIXoQ/+DArOHSCNKiyIsorfQtoyioMekfXSQQi0xoZdIArX82CQfxEjMr9X9mt2dmXV3ZndmdmZu59ydWdcluvDj3nvm3N/8zjn3XCaeJkUMjKmfv2oW14KtXCzeHIzwLaGo2BLgYlfGJ6bbR79N3gPc9fnDV9EejAgtoYjQDOtrK+vBejzvrL1xuqymtZwxCSlGw/yi7ymBoeiEZGA2ALoFXGfyZrSpuIHB8YlhStjQ0edw3a5hNDNLCH/rQIewmFJk1dRl1dAlRcfZQMDaSGkmrnWY9WQ6o6J/NC714/k9jW96Ss+01zHEUrjmD7vRIakYWoiXzLismSnVMIHABDIKXCeAzbKhWBIREgN4/uD1d2zFpe6qHGGA4zvRAfw1UdJMIamSzZRG0hmTAAEFfCNAZO8pYSwuUcLKB8PsoSa3Cwl3oGHFF3iCDuCooTIhqZBIPEVJkQRCpEQ4475Q4alnX1jXww9VzPKanyr0h6KPbEIMD5VtpjIkKEjblBUqjIpZhee6x9mTd165mLP1DfvQsLoRemwTytncEYkSGCQkyCQB5Ol/hBwVk5Sw9e0M2+wZqWTabt5yomGjQKEVFoUoazR8KBSRt+yUkLNC7vw0x17u8tAc7kSDL8C57aLYCm1g+FgkQdJoGjAFhUXxjC2wL4fGqxgxmaY53AhGtimU1S2FGDYWQ5BUuKcy3duEdlGGZlZZ9+veupzCfEJUaKnIAYkxh4m0ToK8nCMM81nCsfkg+35k5niOEK6NHbKCHQKKKLAzIG+0a1KaQW1AqsPlV7PNR2inzC5Fejy9gyeYgcGPu9AAD0IXsXrVtGAUrIm1tv0+e9fJ/Rf9tJf/BMS+r5Oz1cyFpou0ygtLq23hmPg7KiS+c/zmdFRMTEF/e+H1meb4uBdeF29MTE7B3huG72lFmWxs755jys8/x/PL62H36MSPI0zewGfMAcAUYKFKAWWAEgvF1jeHhZLaY/t3Vx89UF7AAU+P08n8Z2BK9lo/KByOwxWOonzDX8KgqrzCNy/dAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"png\"\n        title=\"png\"\n        src=\"/static/fdd383bd5ac698167850e7bd06abd7c3/fcda8/output_26_1.png\"\n        srcset=\"/static/fdd383bd5ac698167850e7bd06abd7c3/12f09/output_26_1.png 148w,\n/static/fdd383bd5ac698167850e7bd06abd7c3/e4a3f/output_26_1.png 295w,\n/static/fdd383bd5ac698167850e7bd06abd7c3/fcda8/output_26_1.png 590w,\n/static/fdd383bd5ac698167850e7bd06abd7c3/f7616/output_26_1.png 766w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>Final thoughts</h2>\n<p>We ended up with a final test accuracy of around 94.4% with our 200k parameter model. Seems not too shabby, considering that the baseline method in the <a href=\"https://arxiv.org/pdf/1804.03209.pdf\">SpeechCommands paper</a> results in an accuracy of 88.2% with the best model, which I think is referred to as <em>cnn-trad-fpool3</em> with 250k parameters. I’m not exactly sure since they don’t explicitly mention those details in the paper and refer to another paper from 2015, which itself has more than a few models.</p>\n<h4>Next steps to improve performance</h4>\n<ol>\n<li>The idea of a background class seems a bit strange. It definitely makes the data balance off and model could cheat by just saying something is background</li>\n<li>In background, we probably can differentiate between silence, noise (type of noise), speech, etc. This may result in better representations</li>\n<li>Better model architecture: like ResNets, lower parameter count / complexity.</li>\n<li>Better training: multi-task learning, self-supervised learning</li>\n<li>Built in Denoising, Dereverb, Speaker Normalization</li>\n</ol>\n<h4>Wishlist</h4>\n<ol>\n<li>Use this model on my voice on real-time audio stream in a browser and study generalization on different microphones</li>\n<li>Capability to train (finetune) the model in an online (supervised) fashion</li>\n<li>Understanding model predictions and debug methods for misclassified examples</li>\n</ol>","excerpt":"This is a tutorial post on speech commands recognition using the Speech Commands dataset. The goals for this post Work with audio data using torchaudio: look at…","frontmatter":{"title":"Speech Commands recognition using ConvNets in PyTorch (Tutorial)","date":"2020-08-10T00:00:00.000Z","subject":["ml","tutorial","pytorch","audio","speech","kws","voice","cnn"],"author":"RSP","featimg":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAxNAAAMTQHSzq1OAAAFV0lEQVQ4yyVUaVAUZxB9M7sgsAtqMEUshWA0xrIUjUFFkyAiRjFWGY2UR0SMZ+TwwgPkFGRXFETQIJ5EoUATNUZDLSgmCBq88AgQ8NZlBQQTBGGV3Znp9OqP/jHv637f1/36DSDUhEFVnw7c0WGYMR1fPP0RU57sdgxp3mY3oUEP3MiAQ8VHgIM9EBMPIXYHsEGHr8/sFPvq935zITHdy3RHj4HlNjwGsHtUB3UXAU2k8ifS6hRySbRSn+hO0gabGZdJcKyZDEALJCgQ0hhLIsdVVSR8/DPlXZtBWZRMveZVMZ7wBrD/5xLUdfzx9xv7Na8sI9qvWr1ryy29dQ0WbXgTJzwlQXttAiBquKAZQiLnxnQ7jDligUu2dW1JhGXpg9xu9CwlARuNgFdDJQa2E/r/Ky2qzlFSKVzpW/5QUa1vV+zWtFkBI0FzzY9bZsL4VmALE8ZKQLoCbFMCcvcry7sOyj0+L7PhjRACzVcxlKhPUL3yuMqdWo/2ouBrB2nor7fIPf8ht9hMKhRPhMsnTJj0H6CztUZwPEUql0wqG+xGlA0KLs5mvLAZ4szOi5hMNGrp1U7SwUwl6KLrMC9q22d2Kzd2ItBMquFVvni/UAOPcyYgk19d0AWtwQy73K5Sn6FmmoeuopJpkuhf9xhCwMkQDCqKd/U5tCl04YT4uZFTdfPCpm51nVISjVFNUarp9YlY+dSD1bNDj4w1QFQssDkKQtIWJ99UXeCBzC2he36ICly8MVbdL3MVi7evEijm557im3+RgXyezXEZDndltXunBXhN8OjwEwBuOa6FiXj40Va4HJen52Uo85uPyohvlOB8hjlSnvHFZ6/A4QZBvCSLKCRRXUKi6iwfviT0Jlm9msj5WCuLwoRCwgsIySQiSoHzCVqSs5EKKIjcDt9TMNy2NoVNnFd0BShhJa9KcKvm11W8De8Fp5VNx/RSCOWTu6WaCQUNxMQXNpVV4mbu5KASm/atYlLclTl0SHaveEbO3xsb+d7av6C5T3B/bkG/55Ig1kgY0CAZivwkWoXu87cn0QzK5z0crxFUKc+BZFY9iUeRJ4WFRkiSDtL9y/0tBvKn3bSERVtgrhYiiDCHw/td2C8gqpzrTWYPEEXYk2UHAoB2rSgkdAsqm1OSSbP8AukMW6lhpRtVGXxo75u1tOJm6itg/ZNQYXHLDoS2pWD83Z0YcWuX0+jLmUdCv0z9M27k1t/jxu0sCxnEXs6xF4V1cezXVCBML2iyMj5INGQOPl26670VVXqM/yMVnobNcBx7Ig+IrgPW3WT2aiCyFljNsfsOkFbF7rjPDvB2AzliWGeZMOt1jbim45Z276MaBL2qxYBizg2/xRw1IjaUwnPdZS48ziqnEIRUm/SkctpPnovLyPW7SlL1yCcHMWISRNJidrdZ3M5jiSEaUnuPfFtuU6+Q37gmjgS77Vyf0A7/3YZKOF/m3dJbVeokVm+LPCsqTu5u6S0XtIVYMPKR7Wfgx9PU9K150OJjLie3l4+te8wh8gXyk8dExXNNvFVU234a8c8wreAUE14hNWIkDvZujrJn/lfK88M9lY49jtbtByLJKzbfbzid1IztKm2NlPW068FKqf66p3LQskxxCD/Ja7ZRgjrpHeHC3Ozr8O1gs59kIJ8CgrKodZoT0Qa8Nf1d42jykssmDlmbpvGmirafGoKJJvDZCJChMpBcYwq5LpoEdYqNsAWHzs88G3o648WyjDTjtPQjpsrDn5ooCqYXuVpTV5bwtProhy+zTs0eB8/XTtA1Vk9KPdZ8Mfsz4/WkwaYj5+abNLMKefc2GCHG8Y7G3PwfTbHKhRz2kf0AAAAASUVORK5CYII=","aspectRatio":1.0638297872340425,"src":"/static/842d14906ffb1a2c699e465c17560cca/497c6/output_5_0.png","srcSet":"/static/842d14906ffb1a2c699e465c17560cca/65e33/output_5_0.png 100w,\n/static/842d14906ffb1a2c699e465c17560cca/69585/output_5_0.png 200w,\n/static/842d14906ffb1a2c699e465c17560cca/497c6/output_5_0.png 400w,\n/static/842d14906ffb1a2c699e465c17560cca/2a4de/output_5_0.png 600w,\n/static/842d14906ffb1a2c699e465c17560cca/ee604/output_5_0.png 800w,\n/static/842d14906ffb1a2c699e465c17560cca/b542f/output_5_0.png 1164w","sizes":"(max-width: 400px) 100vw, 400px"}}}},"fields":{"slug":"/tutorial-pytorch-speechcommands/output/","readingTime":{"text":"8 min read"}}},"site":{"siteMetadata":{"title":"JumpML"}}},"pageContext":{"slug":"/tutorial-pytorch-speechcommands/output/"}}}